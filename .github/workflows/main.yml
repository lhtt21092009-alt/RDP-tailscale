name: RDP-Ngrok-NRA-Stable

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: 1. Configure RDP & User
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          
          $username = "RDP"
          $password = "Oibanoi874@" 
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) { Remove-LocalUser -Name $username }
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Restart-Service -Name TermService -Force

      - name: 2. Setup Ngrok & Get URL
        shell: pwsh
        run: |
          # Cài đặt Ngrok
          choco install ngrok -y
          
          # Cấu hình Token
          $token = "${{ secrets.NGROK_AUTHTOKEN }}"
          & "C:\ProgramData\chocolatey\bin\ngrok.exe" config add-authtoken $token
          
          # Chạy Ngrok ở cửa sổ mới và đợi lâu hơn (30 giây)
          Write-Host "Dang khoi tao Ngrok Tunnel..."
          Start-Process -FilePath "C:\ProgramData\chocolatey\bin\ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
          Start-Sleep -Seconds 30
          
          # Vòng lặp lấy URL (Thử lại trong 2 phút nếu chưa thấy)
          $ngrok_url = ""
          $timeout = Get-Date -Format "T"
          Write-Host "Bat dau tim URL tu luc: $timeout"
          
          for($i=0; $i -lt 12; $i++) {
              try {
                  $api = Invoke-WebRequest -Uri http://127.0.0.1:4040/api/tunnels -UseBasicParsing -ErrorAction Stop
                  $json = $api.Content | ConvertFrom-Json
                  $ngrok_url = $json.tunnels[0].public_url
                  if ($ngrok_url) { break }
              } catch {
                  Write-Host "Ngrok API chua san sang, doi 10s... (Lan $i)"
                  Start-Sleep -Seconds 10
              }
          }

          if (-not $ngrok_url) {
              Write-Error "KHONG LAY DUOC LINK NGROK. Hay kiem tra xem Token co dung khong!"
              exit 1
          }
          
          Write-Host "`n" + "*"*30
          Write-Host "KET NOI RDP TAI DAY:"
          Write-Host "Address : $ngrok_url"
          Write-Host "User    : RDP"
          Write-Host "Pass    : Oibanoi874@"
          Write-Host "*"*30 + "`n"
          echo "NGROK_URL=$ngrok_url" >> $env:GITHUB_ENV

      - name: 3. Download & Install Game
        run: |
          $url = "https://rescdnft97vn.xfplayvn.com/apk/NgocRongAwakenver228.exe"
          $outPath = "$env:TEMP\NgocRongAwaken.exe"
          Write-Host "Dang tai game (Viec nay chay ngam, ban co the login RDP ngay)..."
          Invoke-WebRequest -Uri $url -OutFile $outPath -UseBasicParsing
          Start-Process -FilePath $outPath -ArgumentList "/S" -Wait
          Write-Host "Cai dat game hoan tat!"

      - name: 4. Final Monitoring
        run: |
          Write-Host "Link RDP dang hoat dong: $env:NGROK_URL"
          # Mo san thu muc game de ban de thay khi login
          explorer "C:\Program Files (x86)\NgocRongAwaken"
          while ($true) {
              Write-Host "[$(Get-Date)] Runner is alive..."
              Start-Sleep -Seconds 300
          }
